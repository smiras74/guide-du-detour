<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Guide du D√©tour ¬∑ Live Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root {
      --bg: #050816;
      --bg-card: #050816;
      --bg-soft: #0b1120;
      --primary: #22c55e;
      --primary-soft: rgba(34, 197, 94, 0.15);
      --accent: #a5b4fc;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --border-soft: #1f2937;
      --danger: #f97373;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    body { display: flex; justify-content: center; align-items: stretch; }

    .app-shell {
      width: 100%; max-width: 430px; height: 100vh;
      background: radial-gradient(circle at top, #020617 0%, #020617 26%, #020617 100%);
      overflow: hidden; position: relative; color: var(--text-main);
    }

    /* UTILS */
    .hidden { display: none !important; }
    .centered { display: flex; justify-content: center; align-items: center; }

    .chip {
      display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px;
      border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px; letter-spacing: .08em; text-transform: uppercase;
      color: #9ca3af; background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
    }

    .btn-primary {
      width: 100%; padding: 16px; border-radius: 999px; border: none;
      background: linear-gradient(90deg, #16a34a, #22c55e);
      color: #020617; font-weight: 700; font-size: 16px; cursor: pointer;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3), 0 15px 35px rgba(22, 163, 74, 0.5);
      transition: transform 0.1s;
    }
    .btn-primary:active { transform: translateY(1px); box-shadow: 0 8px 22px rgba(22, 163, 74, 0.6); }

    .section {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9) 0%, #020617 55%);
      border-radius: 24px; border: 1px solid rgba(31,41,55,0.9);
      padding: 18px 18px 20px; margin-bottom: 14px;
      box-shadow: 0 24px 60px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,0.9);
    }
    .section-title { font-size: 12px; letter-spacing: .18em; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; }
    .section-sub { font-size: 13px; color: var(--text-sub); margin-top: 6px; }

    .pill-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .pill-toggle {
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border-soft);
      background: rgba(15,23,42,0.9); color: var(--text-sub); font-size: 13px; cursor: pointer;
    }
    .pill-toggle.active {
      border-color: rgba(34,197,94,0.7);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.12), rgba(15,23,42,0.95));
      color: #bbf7d0;
    }

    /* SPLASH */
    #splash-screen {
      position: absolute; inset: 0; z-index: 20;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 32px 24px 40px;
    }
    .splash-logo { width: 120px; height: auto; margin-bottom: 18px; opacity: 0.9; }
    .splash-title { font-size: 24px; letter-spacing: .25em; text-transform: uppercase; color: #e5e7eb; text-align: center; margin-bottom: 8px; }
    .splash-sub { font-size: 11px; letter-spacing: .18em; text-transform: uppercase; color: #6b7280; text-align: center; margin-bottom: 30px; }
    .splash-progress {
      width: 70%; max-width: 320px; height: 3px; border-radius: 999px;
      background: rgba(15,23,42,0.95); overflow: hidden; position: relative; margin-bottom: 20px;
    }
    .splash-progress-bar {
      position: absolute; inset: 0;
      background: linear-gradient(90deg, rgba(34,197,94,0), #22c55e, rgba(34,197,94,0.2), rgba(34,197,94,0));
      animation: splashBar 3.5s ease-in-out forwards;
    }
    @keyframes splashBar { from { transform: translateX(-70%); opacity: 0.7; } 50% { opacity: 1; } to { transform: translateX(0); opacity: 1; } }
    .splash-tagline { font-size: 13px; color: #d1d5db; text-align: center; }
    .splash-tagline span { font-weight: 600; }
    .splash-footer { position: absolute; bottom: 18px; font-size: 11px; color: #6b7280; text-align: center; width: 100%; }

    /* AUTH */
    #auth-screen {
      position: absolute; inset: 0; z-index: 15; display: none;
      justify-content: center; align-items: center; padding: 20px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
    }
    .auth-card {
      width: 100%; max-width: 360px; background: radial-gradient(circle at top left, rgba(15,23,42,0.96), #020617);
      border-radius: 28px; padding: 26px 22px 22px; border: 1px solid rgba(31,41,55,0.9);
      box-shadow: 0 24px 70px rgba(0,0,0,0.75), 0 0 0 1px rgba(15,23,42,1);
    }
    .logo-pill {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px;
      border-radius: 999px; border: 1px solid rgba(148,163,184,0.6);
      font-size: 11px; letter-spacing: .14em; text-transform: uppercase; color: #9ca3af; margin-bottom: 14px;
    }
    .logo-pill::before {
      content: ''; width: 6px; height: 6px; border-radius: 999px;
      background: radial-gradient(circle, #22c55e 0%, #16a34a 40%, rgba(34,197,94,0.1) 100%);
      box-shadow: 0 0 12px rgba(34,197,94,0.8);
    }
    .auth-tabs { display: flex; padding: 4px; border-radius: 999px; background: rgba(15,23,42,0.9); border: 1px solid rgba(31,41,55,0.9); margin-bottom: 18px; }
    .auth-tabs .tab { flex: 1; padding: 8px 10px; font-size: 14px; border-radius: 999px; border: none; background: transparent; color: #9ca3af; font-weight: 500; cursor: pointer; }
    .auth-tabs .tab.active { background: radial-gradient(circle at top left, rgba(148,163,184,0.18), rgba(15,23,42,1)); color: #e5e7eb; box-shadow: 0 0 0 1px rgba(148,163,184,0.6); }
    .input-wrapper { position: relative; margin-bottom: 14px; }
    .input-field {
      width: 100%; padding: 14px 14px 12px; border-radius: 16px;
      border: 1px solid rgba(31,41,55,1); background: rgba(15,23,42,0.96); color: #f9fafb; font-size: 15px;
    }
    .input-field:focus { outline: none; border-color: var(--accent); background: #020617; box-shadow: 0 0 0 1px rgba(129,140,248,0.7); }
    .input-label { position: absolute; left: 14px; top: 13px; font-size: 14px; color: #6b7280; pointer-events: none; transition: .18s ease; }
    .input-field:focus + .input-label, .input-field:not(:placeholder-shown) + .input-label { top: -7px; left: 11px; font-size: 11px; padding: 0 4px; color: var(--accent); background: #020617; border-radius: 999px; }
    .divider { display: flex; align-items: center; margin: 18px 0 10px; font-size: 12px; color: #6b7280; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid rgba(31,41,55,0.9); }
    .divider span { padding: 0 10px; }
    .social-login { display: flex; justify-content: center; gap: 12px; margin-bottom: 6px; }
    .social-btn { width: 44px; height: 44px; border-radius: 16px; border: 1px solid rgba(31,41,55,1); background: radial-gradient(circle at top, rgba(15,23,42,1), #020617); color: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: default; }
    .auth-hint { font-size: 11px; color: #6b7280; text-align: center; margin-top: 4px; }

    /* MAIN */
    #main-screen { position: absolute; inset: 0; padding: 18px 16px 20px; display: none; overflow-y: auto; }
    header.app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .app-title h2 { font-size: 26px; margin: 0; }
    .app-title p { margin: 0; font-size: 14px; color: var(--text-sub); }
    .avatar-btn { width: 34px; height: 34px; border-radius: 999px; background: radial-gradient(circle at top left, rgba(148,163,184,0.2), rgba(15,23,42,1)); border: 1px solid rgba(148,163,184,0.7); color: #e5e7eb; display: flex; justify-content: center; align-items: center; font-weight: 600; cursor: pointer; }
    .field-label { font-size: 13px; color: #9ca3af; margin-bottom: 4px; }
    .route-field { width: 100%; padding: 12px 14px; border-radius: 999px; border: 1px solid rgba(31,41,55,1); background: rgba(15,23,42,0.96); color: #f9fafb; font-size: 15px; margin-bottom: 8px; }
    .route-actions { display: flex; gap: 10px; margin-top: 6px; }
    .btn-ghost { flex: 1; padding: 9px 10px; border-radius: 999px; border: 1px solid rgba(31,41,55,1); background: rgba(15,23,42,0.98); color: #e5e7eb; font-size: 13px; cursor: pointer; }
    
    /* SLIDER */
    .slider-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 10px; }
    .range-input { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; border-radius: 999px; background: linear-gradient(90deg, rgba(34,197,94,0.2), rgba(34,197,94,0.7)); outline: none; }
    .range-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 999px; background: #22c55e; box-shadow: 0 0 0 6px rgba(34,197,94,0.25); border: none; cursor: pointer; }

    /* MAP SCREEN */
    #map-screen { position: absolute; inset: 0; padding: 18px 16px 20px; display: none; flex-direction: column; }
    .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
    .map-header h3 { margin: 0; font-size: 16px; color: #e5e7eb; }
    .map-back { border-radius: 999px; padding: 6px 12px; border: 1px solid rgba(31,41,55,1); background: rgba(15,23,42,0.96); color: #e5e7eb; font-size: 13px; cursor: pointer; }
    
    /* Leaflet Container Override */
    #map-container { 
      flex: 1; border-radius: 24px; border: 1px solid rgba(31,41,55,1); 
      margin-bottom: 14px; overflow: hidden; position: relative; z-index: 1;
    }

    .map-note { font-size: 12px; color: #9ca3af; margin-top: auto; text-align: center; }

    /* PROFILE MODAL */
    #profile-modal { position: absolute; inset: 0; display: none; justify-content: center; align-items: flex-end; padding: 0 12px 16px; background: radial-gradient(circle at top, rgba(15,23,42,0.6), rgba(15,23,42,0.9)); z-index: 25; }
    #profile-modal.visible { display: flex; }
    .profile-card { width: 100%; max-width: 420px; background: radial-gradient(circle at top left, rgba(15,23,42,1), #020617); border-radius: 26px; border: 1px solid rgba(31,41,55,1); padding: 18px 18px 20px; box-shadow: 0 26px 80px rgba(0,0,0,0.9); }
    .profile-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .profile-close { width: 26px; height: 26px; border-radius: 999px; border: 1px solid rgba(55,65,81,1); background: rgba(15,23,42,0.95); color: #9ca3af; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .pill-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .pill { padding: 7px 11px; border-radius: 999px; border: 1px solid rgba(31,41,55,1); font-size: 13px; background: rgba(15,23,42,0.96); color: #e5e7eb; cursor: pointer; }
    .pill.selected { border-color: rgba(34,197,94,0.8); background: radial-gradient(circle at top left, rgba(34,197,94,0.18), rgba(15,23,42,1)); color: #bbf7d0; }

    /* Leaflet Overrides for Dark Theme */
    .leaflet-container { background: #0b1120; }
  </style>
</head>
<body>
<div class="app-shell">

  <div id="splash-screen">
    <div style="font-size:40px; margin-bottom:10px;">üåÄ</div>
    <div class="splash-title">GUIDE DU D√âTOUR</div>
    <div class="splash-sub">LE VOYAGE HORS DE LA LIGNE DROITE</div>
    <div class="splash-progress"><div class="splash-progress-bar"></div></div>
    <div class="splash-tagline"><span>√áa vaut le d√©tour</span> ‚Äî √† chaque trajet.</div>
    <div class="splash-footer">Live Prototype ¬∑ v0.9.5</div>
  </div>

  <div id="auth-screen">
    <div class="auth-card">
      <div class="logo-pill">Guide du D√©tour</div>
      <h1>Bienvenue</h1>
      <p class="subtitle" style="color:#9ca3af; margin-bottom:18px;">Connectez-vous pour pr√©parer vos d√©tours.</p>

      <div class="auth-tabs">
        <button class="tab active" id="tab-login">Connexion</button>
        <button class="tab" id="tab-register">Inscription</button>
      </div>

      <div class="input-wrapper">
        <input type="email" id="auth-email" class="input-field" placeholder=" " value="demo@detour.fr" />
        <label for="auth-email" class="input-label">Email</label>
      </div>
      <div class="input-wrapper">
        <input type="password" id="auth-password" class="input-field" placeholder=" " value="123456" />
        <label for="auth-password" class="input-label">Mot de passe</label>
      </div>

      <button id="auth-action-btn" class="btn-primary">Se connecter</button>
      <div class="divider"><span>ou</span></div>
      <div class="social-login">
        <button class="social-btn">Ô£ø</button><button class="social-btn">G</button><button class="social-btn">Fb</button>
      </div>
      <p class="auth-hint">Appuyez simplement sur "Se connecter" pour tester.</p>
    </div>
  </div>

  <div id="main-screen">
    <header class="app-header">
      <div class="app-title">
        <div class="chip">Guide du D√©tour ¬∑ Live</div>
        <h2>Bonjour !</h2>
        <p>Choisissez un trajet, nous nous occupons des d√©tours.</p>
      </div>
      <button id="avatar-btn" class="avatar-btn">A</button>
    </header>

    <section class="section">
      <div class="section-title">Trajet</div>
      <label class="field-label" for="start-input">Point de d√©part</label>
      <input id="start-input" class="route-field" type="text" value="Saint-Germain-sur-Morin" />

      <label class="field-label" for="end-input">Destination</label>
      <input id="end-input" class="route-field" type="text" value="Disneyland Paris" />

      <div class="route-actions">
        <button id="btn-mypos" class="btn-ghost">üìç Ma position</button>
        <button id="btn-swap" class="btn-ghost">üîÑ Inverser</button>
      </div>
    </section>

    <section class="section">
      <div class="section-title">Rayon de libert√©</div>
      <p class="section-sub">Distance maximale pour le d√©tour.</p>
      <div class="slider-row">
        <input id="radius-range" type="range" min="1" max="20" value="5" class="range-input" />
        <span id="radius-label">5 km</span>
      </div>
    </section>

    <section class="section">
      <div class="section-title">√âviter</div>
      <div class="pill-row" id="avoid-row">
        <button class="pill-toggle" data-key="tolls">P√©ages</button>
        <button class="pill-toggle active" data-key="motorways">Autoroutes</button>
      </div>
    </section>

    <button id="trace-btn" class="btn-primary" style="margin-bottom:20px;">Tracer l'itin√©raire</button>
  </div>

  <div id="map-screen">
    <div class="map-header">
      <h3>Carte Interactive</h3>
      <button id="btn-back-main" class="map-back">‚Üê Retour</button>
    </div>

    <div class="section" style="padding: 10px 15px; margin-bottom: 10px;">
        <div style="font-size:12px; color:#9ca3af;">
            De <strong id="map-from" style="color:#fff;">A</strong> √† <strong id="map-to" style="color:#fff;">B</strong> (+<span id="map-extra-km">0</span>km)
        </div>
    </div>

    <div id="map-container"></div>

    <button class="btn-primary map-nav-btn">üöó D√©marrer la navigation</button>
    <p class="map-note">Les points jaunes sont des d√©tours sugg√©r√©s.</p>
  </div>

  <div id="profile-modal">
    <div class="profile-card">
      <div class="profile-header-row">
        <h3>Profil du voyageur</h3>
        <button id="profile-close" class="profile-close">√ó</button>
      </div>
      <div class="input-wrapper">
        <input id="profile-name" class="input-field" placeholder=" " />
        <label for="profile-name" class="input-label">Votre pr√©nom</label>
      </div>
      <div class="section-sub" style="margin-bottom:8px;">Vos int√©r√™ts (pour g√©n√©rer les d√©tours)</div>
      <div class="pill-grid" id="interests-grid">
        <button class="pill selected" data-key="gastronomie">Gastronomie</button>
        <button class="pill" data-key="vignobles">Vignobles</button>
        <button class="pill selected" data-key="nature">Nature</button>
        <button class="pill" data-key="chateaux">Ch√¢teaux</button>
      </div>
      <button id="profile-save" class="btn-primary" style="margin-top:14px;">Enregistrer</button>
    </div>
  </div>

</div>

<script>
  // === STATE & DOM ELEMENTS ===
  const els = {
    splash: document.getElementById('splash-screen'),
    auth: document.getElementById('auth-screen'),
    main: document.getElementById('main-screen'),
    map: document.getElementById('map-screen'),
    profile: document.getElementById('profile-modal'),
    radiusRange: document.getElementById('radius-range'),
    radiusLabel: document.getElementById('radius-label'),
    startInput: document.getElementById('start-input'),
    endInput: document.getElementById('end-input'),
    mapContainer: document.getElementById('map-container')
  };

  let mapInstance = null;
  let routeLayer = null;
  let detourLayer = null;

  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –¥–µ–º–æ (Saint-Germain -> Disney)
  const DEMO_COORDS = {
    start: [48.8896, 2.8147],
    end: [48.8706, 2.7789]
  };

  // === LIFECYCLE ===
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      els.splash.style.display = 'none';
      const loggedIn = localStorage.getItem('gddLoggedIn');
      if(loggedIn) showScreen('main'); else showScreen('auth');
      
      const savedName = localStorage.getItem('gddName');
      if(savedName) updateAvatar(savedName);
    }, 3500);
  });

  function showScreen(name) {
    [els.auth, els.main, els.map].forEach(el => el.style.display = 'none');
    if(name === 'auth') els.auth.style.display = 'flex';
    if(name === 'main') els.main.style.display = 'block';
    if(name === 'map')  {
      els.map.style.display = 'flex';
      setTimeout(initMap, 100); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É div
    }
  }

  // === UI INTERACTIONS ===
  
  // Auth
  document.getElementById('auth-action-btn').addEventListener('click', () => {
    localStorage.setItem('gddLoggedIn', '1');
    showScreen('main');
    openProfile(true);
  });

  // Radius Slider
  els.radiusRange.addEventListener('input', (e) => {
    els.radiusLabel.textContent = e.target.value + ' km';
  });

  // My Position (Browser Geolocation)
  document.getElementById('btn-mypos').addEventListener('click', () => {
    if("geolocation" in navigator) {
        const btn = document.getElementById('btn-mypos');
        btn.textContent = '‚è≥ Localisation...';
        navigator.geolocation.getCurrentPosition((pos) => {
            els.startInput.value = "Ma position actuelle";
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –±—ã pos.coords.latitude/longitude
            // –ù–æ –¥–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
            btn.textContent = 'üìç Ma position';
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–ª–∞—Å—å –≥–¥–µ-—Ç–æ —Ä—è–¥–æ–º (–¥–ª—è —Ç–µ—Å—Ç–∞ –æ—Å—Ç–∞–≤–∏–º —Ñ–∏–∫—Å)
        }, (err) => {
            alert("Acc√®s localisation refus√© ou erreur.");
            btn.textContent = 'üìç Ma position';
        });
    } else {
        alert("G√©olocalisation non support√©e.");
    }
  });

  document.getElementById('btn-swap').addEventListener('click', () => {
      const temp = els.startInput.value;
      els.startInput.value = els.endInput.value;
      els.endInput.value = temp;
  });

  // Go to Map
  document.getElementById('trace-btn').addEventListener('click', () => {
    if(!els.startInput.value || !els.endInput.value) return alert("Remplissez les champs !");
    document.getElementById('map-from').textContent = els.startInput.value;
    document.getElementById('map-to').textContent = els.endInput.value;
    document.getElementById('map-extra-km').textContent = (Math.random() * 3).toFixed(1);
    showScreen('map');
  });

  document.getElementById('btn-back-main').addEventListener('click', () => showScreen('main'));

  // Profile
  const openProfile = () => els.profile.classList.add('visible');
  document.getElementById('avatar-btn').addEventListener('click', openProfile);
  document.getElementById('profile-close').addEventListener('click', () => els.profile.classList.remove('visible'));
  
  document.getElementById('profile-save').addEventListener('click', () => {
    const name = document.getElementById('profile-name').value;
    if(name) {
        localStorage.setItem('gddName', name);
        updateAvatar(name);
    }
    els.profile.classList.remove('visible');
  });

  document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => p.classList.toggle('selected'));
  });

  function updateAvatar(name) {
      document.getElementById('avatar-btn').textContent = name.charAt(0).toUpperCase();
  }

  // === MAP LOGIC (LEAFLET) ===
  function initMap() {
    if (mapInstance) {
        mapInstance.invalidateSize(); // –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏ display:none -> block
        generateRouteAndDetours();    // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
        return;
    }

    // 1. –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
    mapInstance = L.map('map-container', {
        zoomControl: false, // –°–∫—Ä–æ–µ–º –∑—É–º, —á—Ç–æ–±—ã –±—ã–ª–æ —á–∏—â–µ
        attributionControl: false
    }).setView(DEMO_COORDS.start, 13);

    // 2. –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –∫–∞—Ä—Ç—ã (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
    }).addTo(mapInstance);

    // –ì—Ä—É–ø–ø—ã —Å–ª–æ–µ–≤
    routeLayer = L.layerGroup().addTo(mapInstance);
    detourLayer = L.layerGroup().addTo(mapInstance);

    generateRouteAndDetours();
  }

  function generateRouteAndDetours() {
      routeLayer.clearLayers();
      detourLayer.clearLayers();

      const radius = parseInt(els.radiusRange.value);
      
      // –ò–∫–æ–Ω–∫–∏
      const iconStart = L.divIcon({html: 'üü¢', className: 'emoji-icon', iconSize: [20,20], iconAnchor: [10,10]});
      const iconEnd = L.divIcon({html: 'üèÅ', className: 'emoji-icon', iconSize: [20,20], iconAnchor: [10,10]});
      const iconDetour = L.divIcon({html: '<div style="width:10px;height:10px;background:#fbbf24;border-radius:50%;box-shadow:0 0 8px #fbbf24;"></div>', className: 'dot-icon'});

      // –ú–∞—Ä–∫–µ—Ä—ã –°—Ç–∞—Ä—Ç/–§–∏–Ω–∏—à
      L.marker(DEMO_COORDS.start, {icon: iconStart}).addTo(routeLayer);
      L.marker(DEMO_COORDS.end, {icon: iconEnd}).addTo(routeLayer);

      // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é (—Ñ–µ–π–∫–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ –ø—Ä—è–º–æ–π –¥–ª—è –¥–µ–º–æ)
      const latlngs = [
          DEMO_COORDS.start,
          [48.8800, 2.7900], // –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –∫—Ä–∏–≤–∏–∑–Ω—ã
          DEMO_COORDS.end
      ];
      const polyline = L.polyline(latlngs, {color: '#22c55e', weight: 4, opacity: 0.8, dashArray: '5, 10'}).addTo(routeLayer);

      mapInstance.fitBounds(polyline.getBounds(), {padding: [50, 50]});

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ "–î–µ—Ç—É—Ä—ã" (–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Å—Ç–∞)
      const detourCount = Math.floor(radius / 1.5) + 2; // –ë–æ–ª—å—à–µ —Ä–∞–¥–∏—É—Å = –±–æ–ª—å—à–µ —Ç–æ—á–µ–∫
      
      for(let i=0; i<detourCount; i++) {
          // –°–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
          const center = mapInstance.getCenter();
          const latOffset = (Math.random() - 0.5) * 0.04 * (radius/5);
          const lngOffset = (Math.random() - 0.5) * 0.04 * (radius/5);
          
          const marker = L.marker([center.lat + latOffset, center.lng + lngOffset], {icon: iconDetour}).addTo(detourLayer);
          marker.bindPopup(`<div style="color:#333"><strong>Lieu cach√© #${i+1}</strong><br>D√©tour: +${(Math.random()*5).toFixed(1)} min</div>`);
      }
  }

</script>
</body>
</html>
