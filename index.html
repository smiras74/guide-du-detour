<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Guide du D√©tour ¬∑ v1.0.3 Hotfix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="icon" type="image/png" href="icon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- VARIABLES & BASIC SETUP --- */
    :root {
      --bg-color: #020617;
      --bg-gradient: radial-gradient(circle at 50% -20%, #1e293b 0%, #020617 80%);
      --text-main: #ffffff;
      --text-sub: #94a3b8;
      --primary: #22c55e;
      --primary-grad: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      --glass-border: rgba(255,255,255,0.15);
      --glass-bg: rgba(15, 23, 42, 0.8);
      --glass-blur: blur(20px);
      --glass-bg-grad: linear-gradient(145deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.02) 100%);
      --glass-shadow: inset 0 1px 1px rgba(255,255,255,0.4), 0 8px 20px rgba(0,0,0,0.3);
      --card-bg: rgba(255, 255, 255, 0.03);
      --active-card-bg: rgba(34, 197, 94, 0.15);
      --active-text: #4ade80;
      --nav-bg: rgba(2, 6, 23, 0.95);
    }
    [data-theme="light"] {
      --bg-color: #f8fafc;
      --bg-gradient: linear-gradient(to bottom, #ffffff 0%, #f1f5f9 100%);
      --text-main: #0f172a;
      --text-sub: #475569;
      --glass-border: rgba(0,0,0,0.08);
      --glass-bg: rgba(255,255,255,0.9);
      --glass-bg-grad: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.7) 100%);
      --glass-shadow: inset 0 1px 1px rgba(255,255,255,0.9), 0 4px 15px rgba(0,0,0,0.05);
      --card-bg: #f8fafc;
      --active-card-bg: #dcfce7; 
      --active-text: #166534;
      --nav-bg: rgba(255, 255, 255, 0.95);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); -webkit-font-smoothing: antialiased; }
    body { display: flex; justify-content: center; align-items: stretch; overflow: hidden; }
    .app-shell { width: 100%; height: 100%; background: var(--bg-gradient); overflow: hidden; position: relative; }
    .btn-primary { width: 100%; padding: 16px; border-radius: 24px; border: none; background: var(--primary-grad); color: #020617; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 8px 20px -6px rgba(34, 197, 94, 0.6); transform: scale(1); transition: 0.2s; }
    .btn-primary:active { transform: scale(0.97); opacity: 0.9; }
    .icon { width: 24px; height: 24px; stroke-width: 2; stroke: currentColor; fill: none; }
    .icon-lg { width: 32px; height: 32px; stroke-width: 1.5; }
    
    /* SCREENS */
    #splash-screen, #auth-screen, #profile-screen, #main-screen { position: absolute; inset: 0; display: flex; flex-direction: column; }
    
    /* SPLASH */
    #splash-screen { z-index: 100; background: #020617; align-items: center; justify-content: center; padding: 30px; }
    .splash-logo { width: 280px; height: auto; margin-bottom: 8px; opacity: 0; animation: fadeUp 1s forwards 0.3s; }
    .splash-slogan { width: 280px; font-size: 12px; color: #94a3b8; text-align: center; margin-bottom: 40px; opacity: 0; animation: fadeUp 1s forwards 0.8s; }
    .splash-progress { width: 280px; height: 2px; border-radius: 99px; background: rgba(255,255,255,0.1); position: relative; opacity: 0; animation: fadeUp 1s forwards 0.1s; overflow: hidden; margin-top: 40px;}
    .splash-progress-bar { position: absolute; inset: 0; background: var(--primary); transform: translateX(-100%); animation: splashBar 6s ease-in-out forwards; }
    .loading-text { font-size: 10px; color: #94a3b8; margin-top: 10px; letter-spacing: 1px; text-transform: uppercase; opacity: 0; animation: fadeUp 1s forwards 0.2s;}
    .app-version { position: absolute; bottom: calc(20px + env(safe-area-inset-bottom)); left: 0; right: 0; text-align: center; font-size: 10px; color: var(--text-sub); opacity: 0.5; font-family: monospace; }
    #profile-screen .app-version { position: relative; bottom: auto; margin: 20px 0; }

    /* AUTH */
    #auth-screen { z-index: 90; background: var(--bg-color); justify-content: center; padding: 32px; display: none; }
    h1.auth-title { font-size: 34px; font-weight: 800; margin: 0 0 10px; color: var(--text-main); }
    .auth-tabs { display: flex; width: 100%; margin-bottom: 32px; position: relative; border-bottom: 1px solid rgba(255,255,255,0.1); justify-content: space-around; gap:0; }
    .tab { flex: 1; background: none; border: none; padding: 12px 0; font-size: 16px; color: rgba(255,255,255,0.5); font-weight: 600; cursor: pointer; transition: 0.3s; text-align: center; }
    .tab.active { color: var(--text-main); }
    .tab-indicator { position: absolute; bottom: -1px; left: 0; height: 2px; width: 50%; background: #4ade80; transition: left 0.3s; }
    .input-wrapper { width: 100%; margin-bottom: 16px; }
    .input-field { width: 100%; padding: 18px 16px; border-radius: 20px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text-main); font-size: 16px; }
    .divider { width: 100%; display: flex; align-items: center; margin: 40px 0 24px; font-size: 13px; color: #64748b; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .social-login { display: flex; gap: 24px; justify-content: center; }
    .social-btn { width: 56px; height: 56px; border-radius: 50%; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; }

    /* PROFILE */
    #profile-screen { z-index: 95; background: var(--bg-color); overflow-y: auto; display: none; }
    .profile-nav { display: flex; justify-content: space-between; align-items: center; padding: calc(16px + env(safe-area-inset-top)) 20px 16px 20px; position: sticky; top: 0; z-index: 10; background: var(--nav-bg); backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border); }
    .nav-title { font-weight: 600; font-size: 17px; color: var(--text-main); opacity: 0.9; }
    .nav-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-main); }
    .profile-content { padding: 0 24px 120px 24px; }
    .hero-section { display: flex; flex-direction: column; align-items: center; padding: 30px 0 20px; text-align: center; }
    .hero-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #334155, #1e293b); display: flex; align-items: center; justify-content: center; font-size: 36px; color: #fff; font-weight: 700; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 0 30px rgba(34, 197, 94, 0.15); margin-bottom: 16px; position: relative; }
    .ghost-input { background: transparent; border: none; text-align: center; color: var(--text-main); font-family: inherit; width: 100%; padding: 4px; margin-bottom: 4px; }
    .input-name { font-size: 26px; font-weight: 800; } .input-sub { font-size: 15px; color: var(--text-sub); }
    .section-header { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 30px 0 16px; display: flex; justify-content: space-between; }
    .interest-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .interest-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .interest-card.active { background: var(--active-card-bg); border-color: var(--primary); }
    .interest-name { font-size: 14px; font-weight: 600; color: var(--text-sub); }
    .interest-card.active .interest-name { color: var(--active-text); }
    .interest-card .icon { stroke: var(--text-sub); } .interest-card.active .icon { stroke: var(--active-text); }
    
    /* FIXED SLIDER CSS */
    .slider-wrapper { width: 100%; padding: 10px 0; }
    .range-input { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, var(--primary) 0%, var(--primary) 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 100%); outline: none; margin: 10px 0; }
    .range-input::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 3px solid var(--bg-color); box-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
    [data-theme="light"] .range-input::-webkit-slider-thumb { border-color: #f8fafc; }

    .settings-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .segment-pill-wrap { background: rgba(255,255,255,0.05); padding: 3px; border-radius: 99px; display: flex; gap: 2px; }
    .segment-pill { padding: 6px 12px; border-radius: 99px; border: none; background: transparent; font-size: 12px; font-weight: 600; color: var(--text-sub); cursor: pointer; transition:0.2s;}
    .segment-pill.active { background: var(--bg-color); color: var(--text-main); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .profile-footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px 24px calc(20px + env(safe-area-inset-bottom)); background: linear-gradient(to top, var(--bg-color) 80%, transparent); z-index: 20; }

    /* MAIN MAP */
    #main-screen { z-index: 10; display: none; }
    #map-container { position: absolute; inset: 0; z-index: 0; background: #0b1120; }
    .map-top-bar { position: absolute; top: calc(16px + env(safe-area-inset-top)); left: 16px; right: 16px; z-index: 20; display: flex; flex-direction: column; gap: 8px; }
    .route-box { background: var(--glass-bg-grad); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-radius: 24px; padding: 14px 16px; display: flex; flex-direction: column; gap: 10px; position: relative; }
    .route-row { display: flex; align-items: center; gap: 12px; }
    .route-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dot-start { background: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); } .dot-end { background: var(--primary); box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
    .route-input { width: 100%; background: transparent; border: none; font-size: 15px; color: var(--text-main); font-weight: 500; padding: 4px 0; }
    .route-input:focus { outline: none; }
    #suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 10px; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 250px; overflow-y: auto; z-index: 9999; padding: 8px; }
    .suggestion-item { padding: 12px; font-size: 14px; color: var(--text-main); border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .map-side-btns { position: absolute; right: 16px; top: calc(160px + env(safe-area-inset-top)); z-index: 20; display: flex; flex-direction: column; gap: 12px; }
    .side-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--glass-bg-grad); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .map-bottom-panel { position: absolute; bottom: 0; left: 0; right: 0; z-index: 20; padding: 20px 16px calc(34px + env(safe-area-inset-bottom)); background: linear-gradient(to top, rgba(0,0,0,0.9) 20%, transparent 100%); display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    #route-info-bar { display: none; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); color: #fff; padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 13px; font-weight: 700; margin-bottom: 12px; text-align: center; align-self: center; pointer-events: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .avoid-row, .go-btn-row { pointer-events: auto; }
    .avoid-row { display: flex; gap: 8px; justify-content: center; }
    .avoid-btn { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 14px; background: var(--glass-bg-grad); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); color: var(--text-sub); font-size: 12px; font-weight: 600; cursor: pointer; }
    .avoid-btn.active { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444; }

    /* MARKERS & POPUPS */
    .user-marker-brand { width: 20px; height: 20px; background: #3b82f6; border: 3px solid #020617; border-radius: 50%; box-shadow: 0 0 10px #3b82f6; }
    .marker-end { width: 20px; height: 20px; background: #22c55e; border: 3px solid #020617; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
    .marker-waypoint { width: 16px; height: 16px; background: #3b82f6; border: 2px solid #ffffff; border-radius: 50%; box-shadow: 0 0 8px rgba(59, 130, 246, 0.8); }
    .poi-marker { width: 32px; height: 32px; background: rgba(15, 23, 42, 0.9); border-radius: 50%; border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    
    .leaflet-popup-content-wrapper { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: #fff; border-radius: 16px; padding: 0; border: 1px solid rgba(255,255,255,0.1); }
    .leaflet-popup-tip { background: rgba(15, 23, 42, 0.95); }
    .popup-card { padding: 16px; min-width: 200px; }
    .popup-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
    .popup-desc { font-size: 12px; color: #94a3b8; margin-bottom: 12px; }
    .popup-btn { width: 100%; padding: 10px; border-radius: 10px; border: none; background: var(--primary); color: #020617; font-weight: 600; font-size: 13px; cursor: pointer; }
    .popup-btn.added { background: rgba(255,255,255,0.1); color: var(--text-sub); cursor: default; }

    /* ANIMATIONS */
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes splashBar { 0% { transform: translateX(-100%); } 100% { transform: translateX(0%); } }

    /* RESTORED LANDSCAPE MODE */
    @media (orientation: landscape) {
        .app-shell { overflow-y: auto; }
        .map-top-bar { top: 20px; left: calc(20px + env(safe-area-inset-left)); width: 300px; right: auto; }
        .map-side-btns { right: calc(20px + env(safe-area-inset-right)); top: 20px; }
        .map-bottom-panel { left: auto; right: calc(20px + env(safe-area-inset-right)); bottom: 20px; width: 300px; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; border: 1px solid var(--glass-border); padding: 20px; pointer-events: auto; }
        .profile-content { padding: 0 100px 100px 100px; }
        .profile-footer { padding: 20px 100px; background: var(--bg-color); }
    }
  </style>
</head>
<body>

<svg style="display: none;">
  <symbol id="icon-close" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></symbol>
  <symbol id="icon-logout" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></symbol>
  <symbol id="icon-loc" viewBox="0 0 24 24"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></symbol>
  <symbol id="icon-toll" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path></symbol>
  <symbol id="icon-hwy" viewBox="0 0 24 24"><path d="M8 2L5 22"></path><path d="M16 2l3 20"></path><path d="M12 12h.01"></path><line x1="12" y1="2" x2="12" y2="22" stroke-dasharray="4 4"></line></symbol>
  <symbol id="icon-offroad" viewBox="0 0 24 24"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></symbol>
  <symbol id="icon-nature" viewBox="0 0 24 24"><path d="M17.5,19C15,19,12.62,17.63,11,15.77C9.38,17.63,7,19,4.5,19C3.12,19,2,17.88,2,16.5C2,12,8,8,11,2C14,8,20,12,20,16.5C20,17.88,18.88,19,17.5,19ZM11,15.77C11,15.77,11,15.77,11,15.77ZM11,4.5C9.06,8.5,4,12.06,4,16.5C4,16.78,4.22,17,4.5,17C6.43,17,8.68,15.68,10.11,13.97L11,12.9L11.89,13.97C13.32,15.68,15.57,17,17.5,17C17.78,17,18,16.78,18,16.5C18,12.06,12.94,8.5,11,4.5Z"></path></symbol>
  <symbol id="icon-history" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></symbol>
  <symbol id="icon-hedonism" viewBox="0 0 24 24"><path d="M7 10h10"></path><path d="M8 14h8"></path><path d="M12 18h0"></path><path d="M6.168 14.828a6 6 0 0 1 11.664 0"></path><path d="M17.832 9.172a6 6 0 0 1-11.664 0"></path><path d="M12 2v1"></path><path d="M12 21v1"></path><path d="M12 5v1"></path><path d="M12 17v1"></path><path d="M5 12H4"></path><path d="M20 12h-1"></path><path d="M9 12v.01"></path><path d="M15 12v.01"></path></symbol>
  <symbol id="icon-curiosity" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></symbol>
  <symbol id="icon-map" viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></symbol>
  <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
</svg>

<div class="app-shell">
  <div id="splash-screen">
    <img src="logo_2.png" alt="Guide du D√©tour" class="splash-logo" onerror="this.style.display='none';" />
    <div class="splash-slogan">√áa vaut le d√©tour ‚Äî √† chaque trajet.</div>
    <div class="splash-progress"><div class="splash-progress-bar"></div></div>
    <div class="loading-text">Chargement...</div>
    <div class="app-version"></div>
  </div>

  <div id="auth-screen">
    <h1 class="auth-title">Bienvenue</h1>
    <div class="auth-tabs">
      <button class="tab active" id="tab-login">Connexion</button>
      <button class="tab" id="tab-register">Inscription</button>
      <div class="tab-indicator" id="tab-line"></div>
    </div>
    <div class="input-wrapper"><input class="input-field" id="email" placeholder="Email" /></div>
    <div class="input-wrapper"><input class="input-field" id="pwd" type="password" placeholder="Password" /></div>
    <button id="btn-auth-action" class="btn-primary">Entrer</button>
    <div class="divider"><span>ou continuer avec</span></div>
    <div class="social-login"><button class="social-btn">Ô£ø</button><button class="social-btn">G</button><button class="social-btn">Fb</button></div>
  </div>

  <div id="profile-screen">
    <div class="profile-nav">
      <button class="nav-btn" id="btn-profile-back"><svg class="icon"><use href="#icon-close"></use></svg></button>
      <span class="nav-title">Profil</span>
      <button class="nav-btn" style="color:#ef4444;" id="btn-logout"><svg class="icon"><use href="#icon-logout"></use></svg></button>
    </div>
    <div class="profile-content">
      <div class="hero-section">
        <div class="hero-avatar"><span id="profile-avatar-char">A</span></div>
        <input id="p-firstname" class="ghost-input input-name" value="Andrey" placeholder="Pr√©nom" />
        <input id="p-lastname" class="ghost-input input-sub" value="Smiras" placeholder="Nom" />
      </div>
      <div class="section-header">Ce que j'aime</div>
      <div class="interest-grid">
        <div class="interest-card" data-cat="nature"><svg class="icon icon-lg"><use href="#icon-nature"></use></svg><div class="interest-name">Nature</div></div>
        <div class="interest-card" data-cat="history"><svg class="icon icon-lg"><use href="#icon-history"></use></svg><div class="interest-name">Histoire</div></div>
        <div class="interest-card" data-cat="hedonism"><svg class="icon icon-lg"><use href="#icon-hedonism"></use></svg><div class="interest-name">H√©donisme</div></div>
        <div class="interest-card" data-cat="curiosity"><svg class="icon icon-lg"><use href="#icon-curiosity"></use></svg><div class="interest-name">Curiosit√©s</div></div>
      </div>
      
      <div class="section-header">Mon Rythme</div>
      <div class="slider-wrapper">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; font-weight:600;">
           <span>Intensit√©</span><span id="slider-val-label" style="color:var(--primary)">Explorateur</span>
        </div>
        <input type="range" min="1" max="3" value="2" step="1" class="range-input" id="adventure-slider">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-sub); padding:0 5px;">
            <span>Touriste</span><span>Curieux</span><span>Explorateur</span>
        </div>
      </div>

      <div class="section-header">Pr√©f√©rences</div>
      <div class="settings-row">
        <span style="font-size:15px; font-weight:500;">Th√®me</span>
        <div class="segment-pill-wrap" id="theme-selector"><button class="segment-pill" data-val="auto">Auto</button><button class="segment-pill" data-val="light">‚òÄÔ∏è</button><button class="segment-pill active" data-val="dark">üåë</button></div>
      </div>
      
      <div class="app-version"></div>
    </div>
    <div class="profile-footer"><button id="btn-save-profile" class="btn-primary">Enregistrer</button></div>
  </div>

  <div id="main-screen">
    <div id="map-container"></div>
    <div class="map-top-bar">
      <div class="route-box">
        <div class="route-row"><div class="route-dot dot-start"></div><input class="route-input" id="start-input" value="Ma position actuelle" placeholder="D√©part" autocomplete="off" /></div>
        <div class="divider-h"></div>
        <div class="route-row"><div class="route-dot dot-end"></div><input class="route-input" id="dest-input" placeholder="O√π on va ?" autocomplete="off" /></div>
        <div id="suggestions-list"></div>
      </div>
    </div>
    <div class="map-side-btns">
      <button class="side-btn" id="btn-profile-open">A</button>
      <button class="side-btn" id="btn-locate"><svg class="icon"><use href="#icon-loc"></use></svg></button>
    </div>
    <div class="map-bottom-panel">
      <div id="route-info-bar"></div>
      <div class="avoid-row">
        <button class="avoid-btn" id="btn-avoid-toll" onclick="this.classList.toggle('active')"><svg class="icon"><use href="#icon-toll"></use></svg>P√©ages</button>
        <button class="avoid-btn" id="btn-avoid-hwy" onclick="this.classList.toggle('active')"><svg class="icon"><use href="#icon-hwy"></use></svg>Autoroutes</button>
        <button class="avoid-btn" id="btn-avoid-offroad" onclick="this.classList.toggle('active')"><svg class="icon"><use href="#icon-offroad"></use></svg>Chemins</button>
      </div>
      <div class="go-btn-row"><button class="btn-primary" id="btn-trace-route">Tracer l'itin√©raire</button></div>
    </div>
  </div>
</div>

<script>
  const APP_VERSION = 'v1.0.3 Hotfix';
  const els={splash:document.getElementById('splash-screen'),auth:document.getElementById('auth-screen'),profile:document.getElementById('profile-screen'),main:document.getElementById('main-screen'),tabLogin:document.getElementById('tab-login'),tabRegister:document.getElementById('tab-register'),authBtn:document.getElementById('btn-auth-action'),tabLine:document.getElementById('tab-line'),pFirstname:document.getElementById('p-firstname'),slider:document.getElementById('adventure-slider'),sliderLabel:document.getElementById('slider-val-label'),startInput:document.getElementById('start-input'),destInput:document.getElementById('dest-input'),traceBtn:document.getElementById('btn-trace-route'),suggestionsList:document.getElementById('suggestions-list'),routeInfo:document.getElementById('route-info-bar')};
  let map,userMarker,tileLayer,routeLayer,detourLayer,corridorLayer,waypointLayer;let isRegisterMode=false;let startCoords=null;let destCoords=null;let destMarker=null;let waypoints=[];let activeCategories=new Set(['nature','history','hedonism','curiosity']);
  const SLIDER_OPTS={1:{label:'Touriste',width:2000},2:{label:'Curieux',width:10000},3:{label:'Explorateur',width:30000}};
  const POI_ICONS={nature:'üåø',history:'üè∞',hedonism:'üç∑',curiosity:'üëΩ'};
  const OVERPASS_TAGS={
    nature:['"natural"="peak"','"tourism"="viewpoint"','"waterway"="waterfall"','"natural"="cave_entrance"'],
    history:['"historic"="castle"','"historic"="ruins"','"historic"="monument"','"building"="church"','"historic"="battlefield"'],
    hedonism:['"craft"="winery"','"shop"="cheese"','"shop"="wine"','"amenity"="marketplace"','"craft"="brewery"'],
    curiosity:['"tourism"="artwork"','"tourism"="attraction"','"tourism"="theme_park"']
  };

  document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.app-version').forEach(el=>el.textContent=APP_VERSION);
    setTimeout(()=>{els.splash.style.display='none';if(localStorage.getItem('gddLoggedIn')){loadProfileData();showScreen('main');}else{showScreen('auth');updateTabLine(els.tabLogin);}},2500);
    document.querySelectorAll('.interest-card[data-cat]').forEach(c=>{const cat=c.getAttribute('data-cat');if(activeCategories.has(cat))c.classList.add('active');c.addEventListener('click',()=>{c.classList.toggle('active');if(c.classList.contains('active'))activeCategories.add(cat);else activeCategories.delete(cat);});});
    updateSlider(els.slider.value);
  });

  function updateSlider(val){const opt=SLIDER_OPTS[val];els.sliderLabel.textContent=opt.label;const perc=(val-1)/(3-1)*100;els.slider.style.background=`linear-gradient(to right, var(--primary) 0%, var(--primary) ${perc}%, rgba(255,255,255,0.1) ${perc}%, rgba(255,255,255,0.1) 100%)`;}
  els.slider.addEventListener('input',(e)=>updateSlider(e.target.value));

  function showScreen(n){els.auth.style.display='none';els.profile.style.display='none';els.main.style.display='none';if(n==='auth')els.auth.style.display='flex';if(n==='profile')els.profile.style.display='flex';if(n==='main'){els.main.style.display='block';setTimeout(()=>{initMap();},100);}}
  function updateTabLine(t){els.tabLine.style.width=t.offsetWidth+'px';els.tabLine.style.left=t.offsetLeft+'px';}
  els.tabLogin.addEventListener('click',()=>{isRegisterMode=false;setTabs();});els.tabRegister.addEventListener('click',()=>{isRegisterMode=true;setTabs();});
  function setTabs(){if(isRegisterMode){els.tabRegister.classList.add('active');els.tabLogin.classList.remove('active');els.authBtn.textContent="Cr√©er un compte";updateTabLine(els.tabRegister);}else{els.tabLogin.classList.add('active');els.tabRegister.classList.remove('active');els.authBtn.textContent="Se connecter";updateTabLine(els.tabLogin);}}
  els.authBtn.addEventListener('click',()=>{localStorage.setItem('gddLoggedIn','1');if(isRegisterMode)showScreen('profile');else{loadProfileData();showScreen('main');}});
  document.querySelectorAll('.segment-pill').forEach(b=>{b.addEventListener('click',()=>{b.parentElement.querySelectorAll('.segment-pill').forEach(i=>i.classList.remove('active'));b.classList.add('active');if(b.parentElement.id==='theme-selector'){const m=b.getAttribute('data-val');if(m==='light')document.documentElement.setAttribute('data-theme','light');else document.documentElement.removeAttribute('data-theme');updateMapTheme();}});});
  document.getElementById('btn-save-profile').addEventListener('click',()=>{localStorage.setItem('gddName',els.pFirstname.value);loadProfileData();showScreen('main');});
  document.getElementById('btn-profile-open').addEventListener('click',()=>{loadProfileData();showScreen('profile');});
  document.getElementById('btn-profile-back').addEventListener('click',()=>{showScreen('main');});
  document.getElementById('btn-logout').addEventListener('click',()=>{localStorage.removeItem('gddLoggedIn');showScreen('auth');});
  function loadProfileData(){const n=localStorage.getItem('gddName')||'Andrey';els.pFirstname.value=n;document.getElementById('profile-avatar-char').textContent=n.charAt(0).toUpperCase();document.getElementById('btn-profile-open').textContent=n.charAt(0).toUpperCase();}

  /* MAP & ROUTING */
  function initMap(){if(map){map.invalidateSize();updateMapTheme();return;}map=L.map('map-container',{zoomControl:false}).setView([48.8566,2.3522],13);updateMapTheme();userMarker=L.marker([48.8566,2.3522],{icon:L.divIcon({className:'custom-div-icon',html:"<div class='user-marker-brand'></div>",iconSize:[20,20],iconAnchor:[10,10]})}).addTo(map);routeLayer=L.layerGroup().addTo(map);corridorLayer=L.layerGroup().addTo(map);detourLayer=L.layerGroup().addTo(map);waypointLayer=L.layerGroup().addTo(map);if(!startCoords&&navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{startCoords={lat:p.coords.latitude,lon:p.coords.longitude};map.setView([startCoords.lat,startCoords.lon],14);userMarker.setLatLng([startCoords.lat,startCoords.lon]);});}map.on('click',async(e)=>{const{lat,lng}=e.latlng;if(destMarker)map.removeLayer(destMarker);destMarker=L.marker([lat,lng],{icon:L.divIcon({className:'marker-end',iconSize:[16,16]})}).addTo(map);destCoords={lat,lon:lng};els.destInput.value="Point...";try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);const d=await r.json();if(d.display_name)els.destInput.value=d.display_name.split(',')[0];}catch{}});}
  function updateMapTheme(){if(!map)return;const l=document.documentElement.getAttribute('data-theme')==='light';const u=l?'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png':'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';if(tileLayer)map.removeLayer(tileLayer);tileLayer=L.tileLayer(u,{maxZoom:20}).addTo(map);}
  document.getElementById('btn-locate').addEventListener('click',()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{startCoords={lat:p.coords.latitude,lon:p.coords.longitude};map.setView([startCoords.lat,startCoords.lon],15);userMarker.setLatLng([startCoords.lat,startCoords.lon]);els.startInput.value="Ma position actuelle";});}});
  function setupAC(el,isS){let t;el.addEventListener('input',(e)=>{clearTimeout(t);if(e.target.value.length<3){els.suggestionsList.style.display='none';return;}t=setTimeout(async()=>{try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}&limit=5`);const d=await r.json();showSugg(d,isS);}catch{}},300);});}
  setupAC(els.startInput,true);setupAC(els.destInput,false);
  function showSugg(d,isS){els.suggestionsList.innerHTML='';if(!d.length){els.suggestionsList.style.display='none';return;}d.forEach(i=>{const div=document.createElement('div');div.className='suggestion-item';div.innerHTML=`<span>üìç</span>${i.display_name.split(',')[0]}`;div.onclick=()=>{if(isS){els.startInput.value=i.display_name.split(',')[0];startCoords={lat:i.lat,lon:i.lon};}else{els.destInput.value=i.display_name.split(',')[0];destCoords={lat:i.lat,lon:i.lon};if(destMarker)map.removeLayer(destMarker);destMarker=L.marker([i.lat,i.lon],{icon:L.divIcon({className:'marker-end',iconSize:[16,16]})}).addTo(map);}els.suggestionsList.style.display='none';};els.suggestionsList.appendChild(div);});els.suggestionsList.style.display='block';}
  document.addEventListener('click',(e)=>{if(!e.target.closest('.route-box'))els.suggestionsList.style.display='none';});

  // --- HOTFIX: Clears detourLayer immediately ---
  els.traceBtn.addEventListener('click',async()=>{
    if(!destCoords||!startCoords)return alert("D√©part et destination requis");
    els.traceBtn.textContent="Calcul..."; els.routeInfo.style.display='none';
    
    routeLayer.clearLayers(); corridorLayer.clearLayers(); detourLayer.clearLayers(); // FIX HERE

    const routePoints=[startCoords,...waypoints,destCoords];
    const coordStr=routePoints.map(p=>`${p.lon},${p.lat}`).join(';');
    let u=`https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson`;
    const exc=[]; if(document.getElementById('btn-avoid-toll').classList.contains('active'))exc.push('toll'); if(document.getElementById('btn-avoid-hwy').classList.contains('active'))exc.push('motorway'); if(exc.length)u+=`&exclude=${exc.join(',')}`;

    try{
        const r=await fetch(u); const d=await r.json();
        if(d.routes&&d.routes.length){
            const rt=d.routes[0];
            L.geoJSON(rt.geometry,{style:{color:'#22c55e',weight:5}}).addTo(routeLayer);
            const dist=(rt.distance/1000).toFixed(1); const dur=Math.round(rt.duration/60); const h=Math.floor(dur/60); const m=dur%60;
            els.routeInfo.textContent=`${h>0?h+'h ':''}${m}min ‚Ä¢ ${dist} km`; els.routeInfo.style.display='block';
            
            const sVal=parseInt(els.slider.value)||2; const width=SLIDER_OPTS[sVal].width;
            L.geoJSON(rt.geometry,{style:{color:'#22c55e',weight:width/500,opacity:0.2,lineCap:'round'}}).addTo(corridorLayer); // Approx visual width
            map.fitBounds(L.geoJSON(rt.geometry).getBounds(),{padding:[50,50]});
            fetchRealDetours(rt.geometry.coordinates, width);
        } else alert("Route introuvable");
    }catch{alert("Erreur");}finally{els.traceBtn.textContent="Tracer l'itin√©raire";}
  });

  async function fetchRealDetours(routeCoords, radius){
      if(activeCategories.size===0)return;
      els.traceBtn.textContent="üîé Recherche de p√©pites...";
      const samples=[]; const step=Math.floor(routeCoords.length/8)||1; 
      for(let i=0;i<routeCoords.length;i+=step) samples.push(routeCoords[i]);
      
      let queries=[]; activeCategories.forEach(cat=>{ OVERPASS_TAGS[cat]?.forEach(tag=>{ samples.forEach(c=>{ queries.push(`node[${tag}](around:${radius},${c[1]},${c[0]});`); }); }); });
      const ql=`[out:json][timeout:15];(${queries.join('')});out body 20;>;out skel qt;`;

      try{
          const r=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:ql}); const d=await r.json();
          const unique=new Set();
          d.elements.forEach(el=>{
              if(el.lat&&!unique.has(el.id)){
                  unique.add(el.id); let icon='üìç'; let cat='curiosity';
                  if(el.tags.historic) {icon=POI_ICONS.history; cat='history';} else if(el.tags.natural||el.tags.waterway||el.tags.tourism=='viewpoint') {icon=POI_ICONS.nature; cat='nature';} else if(el.tags.craft||el.tags.shop||el.tags.amenity) {icon=POI_ICONS.hedonism; cat='hedonism';}
                  
                  const m=L.marker([el.lat,el.lon],{icon:L.divIcon({className:'poi-marker',html:icon})}).addTo(detourLayer);
                  const name=el.tags.name||(el.tags.historic||el.tags.natural||'Lieu Myst√®re');
                  
                  m.bindPopup(`<div class="popup-card"><div class="popup-title">${name}</div><div class="popup-desc">D√©tour: ${cat}</div><button class="popup-btn" onclick="addWaypoint(${el.lat},${el.lon},'${name}',this)">Ajouter au trajet</button></div>`);
              }
          });
      }catch(e){console.log(e);}finally{els.traceBtn.textContent="Tracer l'itin√©raire";}
  }

  window.addWaypoint=(lat,lon,name,btn)=>{
      waypoints.push({lat,lon});
      L.marker([lat,lon],{icon:L.divIcon({className:'marker-waypoint'})}).addTo(waypointLayer);
      btn.textContent="‚úÖ Ajout√©"; btn.classList.add('added'); btn.onclick=null;
      map.closePopup();
      els.traceBtn.click(); // Re-trace immediately
  };
</script>
</body>
</html>
